<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JulioBot - Asistente Inteligente</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/@simondmc/popup-js@1.4.3/popup.min.js"></script>
</head>
<body>
    <!-- Toggle tema oscuro/claro -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">üåô</span> Tema
    </button>

    <!-- Indicador de estado -->
    <div id="status-indicator" class="status-indicator">
        <span id="status-text">En l√≠nea</span>
    </div>

    <div id="chat-container">
        <!-- Cabecera del chat -->
        <div class="chat-header">
            <div class="bot-avatar">ü§ñ</div>
            <div>
                <div class="chat-title">JulioBot</div>
                <div class="chat-status">Asistente Virtual ‚Ä¢ <span id="online-status">En l√≠nea</span></div>
            </div>
        </div>

        <!-- √Årea de mensajes -->
        <div id="chat-messages">
            <!-- Mensaje de bienvenida -->
            <div class="message bot">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    ¬°Hola! üëã Soy JulioBot, tu asistente virtual. Puedes preguntarme cualquier cosa o usar comandos como <code>/help</code> para ver qu√© puedo hacer.
                </div>
            </div>
        </div>

        <!-- Input del chat -->
        <div id="chat-input">
            <input type="text" id="user-input" placeholder="Escribe un mensaje..." autocomplete="off" />
            <button onclick="enviarMensaje()" id="send-btn">
                <span id="send-text">Enviar</span>
                <span id="send-spinner" class="spinner" style="display: none;"></span>
            </button>
        </div>

        <!-- Botones de acci√≥n -->
        <div class="action-buttons">
            <button class="action-btn" onclick="mostrarComandos()">üìã Comandos</button>
            <button class="action-btn" id="popupBtn">‚ûï Agregar consulta</button>
            <button class="action-btn" onclick="window.location.href='/admin'">‚öôÔ∏è Admin</button>
            <button class="action-btn" onclick="limpiarChat()">üóëÔ∏è Limpiar</button>
            <button class="action-btn" onclick="exportarChat()">üíæ Exportar</button>
        </div>
    </div>

    <script>
        // Variables globales
        let conversationHistory = [];
        let isTyping = false;
        let currentTheme = localStorage.getItem('theme') || 'light';

        // Inicializar tema
        document.documentElement.setAttribute('data-theme', currentTheme);
        updateThemeIcon();

        // Configurar popup para agregar consultas
        const myPopup = new Popup({
            id: "my-popup",
            title: "‚ûï Agregar nueva consulta",
            content: `
                <div id="adminPanel" style="padding: 20px;">
                    <div class="form-group">
                        <label for="nuevaConsulta">Consulta:</label>
                        <input type="text" id="nuevaConsulta" placeholder="Escribe la consulta..." style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px;"/>
                    </div>
                    <div class="form-group">
                        <label for="nuevaRespuesta">Respuesta:</label>
                        <textarea id="nuevaRespuesta" placeholder="Escribe la respuesta..." rows="4" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; resize: vertical;"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="nuevaCategoria">Categor√≠a:</label>
                        <input type="text" id="nuevaCategoria" placeholder="general" value="general" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px;"/>
                    </div>
                    <button onclick="agregarConsulta()" style="width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 10px 0;">
                        Agregar Consulta
                    </button>
                    <p id="adminMensaje" style="text-align: center; margin: 10px 0;"></p>
                </div>
            `
        });

        // Event listeners
        document.getElementById('popupBtn').addEventListener('click', () => {
            myPopup.show();
        });

        document.getElementById('user-input').addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                enviarMensaje();
            }
        });

        // Funciones principales
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon();
            showStatusMessage(`Tema ${currentTheme === 'dark' ? 'oscuro' : 'claro'} activado`);
        }

        function updateThemeIcon() {
            const themeIcon = document.getElementById('theme-icon');
            themeIcon.textContent = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        }

        function showStatusMessage(message) {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            statusText.textContent = message;
            statusIndicator.classList.add('show');
            setTimeout(() => {
                statusIndicator.classList.remove('show');
            }, 2000);
        }

        function mostrarIndicadorEscritura() {
            if (isTyping) return;
            isTyping = true;
            
            const chatMessages = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <span>Escribiendo</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function ocultarIndicadorEscritura() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            isTyping = false;
        }

        function enviarMensaje() {
            const userInput = document.getElementById('user-input').value.trim();
            const chatMessages = document.getElementById('chat-messages');
            const sendBtn = document.getElementById('send-btn');
            const sendText = document.getElementById('send-text');
            const sendSpinner = document.getElementById('send-spinner');

            if (!userInput) return;

            // Mostrar spinner en bot√≥n
            sendText.style.display = 'none';
            sendSpinner.style.display = 'inline-block';
            sendBtn.disabled = true;

            // A√±adir mensaje del usuario
            const userMessage = document.createElement('div');
            userMessage.className = 'message user';
            userMessage.innerHTML = `
                <div class="message-content">${escapeHtml(userInput)}</div>
                <div class="message-avatar">üë§</div>
            `;
            chatMessages.appendChild(userMessage);

            // Guardar en historial
            conversationHistory.push({
                type: 'user',
                content: userInput,
                timestamp: new Date().toISOString()
            });

            // Limpiar input
            document.getElementById('user-input').value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Mostrar indicador de escritura
            setTimeout(() => {
                mostrarIndicadorEscritura();
            }, 500);

            // Enviar petici√≥n al servidor
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ mensaje: userInput }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Ocultar indicador de escritura
                setTimeout(() => {
                    ocultarIndicadorEscritura();
                    procesarRespuestaBot(data);
                }, 1000);
            })
            .catch(error => {
                console.error('Error:', error);
                ocultarIndicadorEscritura();
                mostrarErrorMessage('Hubo un error al procesar tu mensaje. Int√©ntalo de nuevo.');
            })
            .finally(() => {
                // Restaurar bot√≥n
                sendText.style.display = 'inline';
                sendSpinner.style.display = 'none';
                sendBtn.disabled = false;
            });
        }

        function procesarRespuestaBot(data) {
            const chatMessages = document.getElementById('chat-messages');
            
            // Procesar respuesta seg√∫n el origen
            if (data.origen === 'palabras') {
                const palabrasHTML = data.respuesta.map(
                    palabra => `<span class="palabras" onclick="seleccionarPalabra('${palabra}')">${palabra}</span>`
                ).join(' ');
                
                const botMessage = document.createElement('div');
                botMessage.className = 'message bot';
                botMessage.innerHTML = `
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <strong>üìù Consultas disponibles:</strong><br><br>
                        ${palabrasHTML}
                    </div>
                `;
                chatMessages.appendChild(botMessage);
            } else {
                // Respuesta normal
                const botMessage = document.createElement('div');
                botMessage.className = 'message bot';
                const responseText = data.origen === 'comando' || data.origen === 'stats' 
                    ? data.respuesta.replace(/\n/g, '<br>')
                    : escapeHtml(data.respuesta);
                
                botMessage.innerHTML = `
                    <div class="message-avatar">${data.origen === 'local' ? 'üòä' : 'ü§ñ'}</div>
                    <div class="message-content">${responseText}</div>
                `;
                chatMessages.appendChild(botMessage);
            }

            // Guardar en historial
            conversationHistory.push({
                type: 'bot',
                content: data.respuesta,
                origen: data.origen || 'bot',
                timestamp: new Date().toISOString()
            });

            // Mostrar sugerencias si existen
            if (data.sugerencias && data.sugerencias.length > 0) {
                const sugerenciasHTML = data.sugerencias.map(
                    s => `<span class="sugerencia" onclick="seleccionarSugerencia('${s}')">${s}</span>`
                ).join(' ');
                
                const sugerenciasDiv = document.createElement('div');
                sugerenciasDiv.className = 'message bot';
                sugerenciasDiv.innerHTML = `
                    <div class="message-avatar">üí°</div>
                    <div class="message-content">
                        <strong>¬øQuiz√°s quisiste decir:</strong><br><br>
                        ${sugerenciasHTML}
                    </div>
                `;
                chatMessages.appendChild(sugerenciasDiv);
            }

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function seleccionarPalabra(palabra) {
            document.getElementById('user-input').value = palabra;
            enviarMensaje();
        }

        function seleccionarSugerencia(sugerencia) {
            document.getElementById('user-input').value = sugerencia;
            enviarMensaje();
        }

        function mostrarErrorMessage(mensaje) {
            const chatMessages = document.getElementById('chat-messages');
            const errorMessage = document.createElement('div');
            errorMessage.className = 'message bot';
            errorMessage.innerHTML = `
                <div class="message-avatar">‚ùå</div>
                <div class="message-content" style="color: #e74c3c;">${mensaje}</div>
            `;
            chatMessages.appendChild(errorMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function mostrarComandos() {
            const chatMessages = document.getElementById('chat-messages');
            const comandosMessage = document.createElement('div');
            comandosMessage.className = 'message bot';
            comandosMessage.innerHTML = `
                <div class="message-avatar">üìã</div>
                <div class="message-content">
                    <strong>üîß Comandos disponibles:</strong><br><br>
                    <code>/help</code> - Mostrar ayuda completa<br>
                    <code>/stats</code> - Ver estad√≠sticas (solo admin)<br>
                    <code>palabras</code> - Ver todas las consultas<br>
                    <code>hola</code> - Saludo<br>
                    <code>gracias</code> - Agradecer<br>
                    <code>adi√≥s</code> - Despedida
                </div>
            `;
            chatMessages.appendChild(comandosMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function limpiarChat() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar el chat?')) {
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = `
                    <div class="message bot">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-content">
                            Chat limpiado. ¬°Hola de nuevo! üëã
                        </div>
                    </div>
                `;
                conversationHistory = [];
                showStatusMessage('Chat limpiado');
            }
        }

        function exportarChat() {
            if (conversationHistory.length === 0) {
                showStatusMessage('No hay conversaci√≥n para exportar');
                return;
            }

            const chatText = conversationHistory.map(msg => {
                const timestamp = new Date(msg.timestamp).toLocaleString();
                const prefix = msg.type === 'user' ? 'Usuario' : 'JulioBot';
                return `[${timestamp}] ${prefix}: ${msg.content}`;
            }).join('\n\n');

            const blob = new Blob([chatText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-juliobot-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatusMessage('Chat exportado');
        }

        function agregarConsulta() {
            const consulta = document.getElementById('nuevaConsulta').value.trim();
            const respuesta = document.getElementById('nuevaRespuesta').value.trim();
            const categoria = document.getElementById('nuevaCategoria').value.trim() || 'general';
            const mensaje = document.getElementById('adminMensaje');

            if (!consulta || !respuesta) {
                mensaje.innerHTML = '<span style="color: #e74c3c;">‚ö†Ô∏è Todos los campos son obligatorios</span>';
                return;
            }

            mensaje.innerHTML = '<span style="color: #3498db;">‚è≥ Agregando consulta...</span>';

            fetch('/api/consultas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    consulta: consulta, 
                    respuesta: respuesta,
                    categoria: categoria 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    mensaje.innerHTML = `<span style="color: #e74c3c;">‚ùå ${data.error}</span>`;
                } else {
                    mensaje.innerHTML = '<span style="color: #27ae60;">‚úÖ Consulta agregada exitosamente</span>';
                    document.getElementById('nuevaConsulta').value = '';
                    document.getElementById('nuevaRespuesta').value = '';
                    document.getElementById('nuevaCategoria').value = 'general';
                    
                    setTimeout(() => {
                        myPopup.close();
                    }, 1500);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mensaje.innerHTML = '<span style="color: #e74c3c;">‚ùå Error al agregar la consulta</span>';
            });
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            showStatusMessage('JulioBot iniciado correctamente');
            document.getElementById('user-input').focus();
        });

        // Mantener conexi√≥n activa
        setInterval(() => {
            document.getElementById('online-status').textContent = 'En l√≠nea';
        }, 30000);
    </script>
</body>
</html>